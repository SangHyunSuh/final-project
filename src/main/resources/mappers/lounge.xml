<?xml version="1.0" encoding="UTF-8"?>
<!-- === mapper 기본설정 ==== -->
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!-- === 루트 엘리먼트 & 네임스페이스 설정(프로젝트 전체내에서 유일해야 한다.) ==== -->
<mapper namespace="com.sist.haebollangce.common.mapper.InterMapper">

	<!-- // === #2. 게시판 글쓰기 완료 요청 === -->
	<insert id="loungeAdd" parameterType="com.sist.haebollangce.lounge.model.LoungeBoardDTO">
		insert into tbl_lounge_board(seq, fk_userid, name, subject, content, pw, readCount, regDate, status)
		values(lounge_boardSeq.nextval, #{fk_userid}, #{name}, #{subject}, #{content}, #{pw}, default, default, default)
	</insert>

	<!-- // #3-1. 페이징 처리 안한 검색어 있는 전체 글 목록 보기  --> 
	<select id="lgboardListSearch" parameterType="HashMap" resultType="com.sist.haebollangce.lounge.model.LoungeBoardDTO">
		select seq, fk_userid, name, subject, content, readcount, regdate, commentCount, 
		       TO_DATE(sysdate, 'YYYY-MM-DD') - TO_DATE(regdate, 'YYYY-MM-DD') as regDate_ago, likeCount
		from tbl_lounge_board
		where status = 1
		<if test=" searchType != '' and searchWord != '' ">
			and lower(${searchType}) like '%' || lower(#{searchWord}) || '%'
		</if>
		order by seq desc
	</select>
	
	<!-- // === #11. 검색어 입력시 자동글 완성하기 (Ajax 로 처리) === --> 
	<select id="lgwordSearchShow" parameterType="HashMap" resultType="String">
		<choose>
         	<when test="searchType eq 'name'">
             	select distinct ${searchType}
         	</when>
         	<otherwise>
            	select ${searchType}
         	</otherwise>
      	</choose>
      			from tbl_lounge_board
             	where status = 1 
             	and lower(${searchType}) like '%'|| lower(#{searchWord}) ||'%'
      	<choose>
         	<when test="searchType neq 'name'">
         		order by ${searchType} asc
            </when>
        	<otherwise>
             	order by commentcount desc, seq desc
         	</otherwise>
      	</choose>
	</select>
	
	<!-- // #4-1.글 조회수 증가와 함께 글 1개를 조회 해주는 것 -->
	<select id="lggetView" parameterType="HashMap" resultType="com.sist.haebollangce.lounge.model.LoungeBoardDTO">
		SELECT seq, fk_userid, name, subject, content, readcount, to_char(regdate, 'yyyy-mm-dd hh24:mi:ss') as regdate, pw, commentCount, 
		       regDate_ago, likeCount
		FROM 
		(   
		    select seq, fk_userid, name, subject, content, readcount, regdate, pw, commentCount, 
		           TO_DATE(sysdate, 'YYYY-MM-DD') - TO_DATE(regdate, 'YYYY-MM-DD') as regDate_ago
		    from tbl_lounge_board
		    where status = 1 and seq = #{seq}
		) LB
		CROSS JOIN
		(
		    select count(*) as likeCount
		    from tbl_lounge_like
		    where fk_seq = #{seq}
		) LL
		order by seq desc
	</select>
	
	<!-- // #4-1-1. 글 조회수 1 증가 -->
	<update id="lgsetAddReadCount" parameterType="String">
		update tbl_lounge_board set readcount = readcount + 1
		where seq = #{seq}
	</update>

	<!-- // === #6. 라운지 글 수정 페이지 요청 완료 === -->
	<update id="lgedit" parameterType="com.sist.haebollangce.lounge.model.LoungeBoardDTO">
		update tbl_lounge_board set subject = #{subject} , content = #{content}
		where seq = #{seq} and pw = #{pw}	
	</update>

	<!-- // === #8. 라운지 글 삭제 페이지 요청 완료 === -->
	<delete id="lgdel" parameterType="HashMap">
		delete from tbl_lounge_board 
		where seq = #{seq}	
	</delete>
	
	<!-- // #9-1. tbl_lounge_comment 댓글쓰기(insert) (원댓글과 대댓글에 차이를 아직안둠)--> 
	<insert id="loungeaddComment" parameterType="com.sist.haebollangce.lounge.model.LoungeCommentDTO">
		insert into tbl_lounge_comment(seq, fk_userid, name, content, regDate, parentSeq, status)
		values(lounge_commentSeq.nextval, #{fk_userid}, #{name}, #{content}, default, #{parentSeq}, default)
	</insert>
	
	<!-- // #9-2. tbl_lounge_board 댓글수증가(update) --> 
	<update id="loungeupdateCount" parameterType="String">
		update tbl_lounge_board set commentCount = commentCount + 1
		where seq = #{parentSeq}
	</update>
	
	<!-- // #9-3. tbl_lounge_comment 테이블에서 groupno 컬럼의 최대값 알아오기
		 // -> 원댓글쓰기 : groupno 컬럼의 최대값(max)+1 로 해서 insert 해야한다  / 최초 글쓰기의 경우 null 이 나오므로 0 으로 바꿔줌~ 
	<select id="getGroupno_max" resultType="int">
		select nvl(max(groupno), 0)
		from tbl_lounge_comment
	</select>-->
	
	<!-- // === #10. 원 게시물에 딸린 댓글들을 조회 === -->
	<select id="lggetCommentList" parameterType="String" resultType="com.sist.haebollangce.lounge.model.LoungeCommentDTO">
		select name, content, to_char(regdate, 'yyyy-mm-dd hh24:mi:ss') AS regdate
		from tbl_lounge_comment
		where status = 1 and parentSeq = #{parentSeq}
		order by seq desc
	</select>













</mapper>